name: Update PKHeX submodule

on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  update-submodule:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Update PKHeX submodule to latest tag
        id: pkhex
        shell: bash
        run: |
          # Ensure submodule is present and up-to-date
          git submodule update --init --recursive

          cd pkhex/PKHeX

          # Fetch tags from upstream
          git fetch --tags --force --prune --verbose

          # Pick the "latest" tag by tag creation date (best with annotated tags)
          latest_tag="$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags | head -n 1)"
          echo "Latest tag found: ${latest_tag}"

          if [[ -z "${latest_tag}" ]]; then
            echo "No tags found in PKHeX submodule."
            exit 1
          fi

          # Checkout that tag
          git checkout -f "${latest_tag}"

          # Output for later steps
          echo "latest_tag=${latest_tag}" >> "$GITHUB_OUTPUT"

          cd ../..

          # Stage the submodule pointer change in the parent repo (if any)
          git add pkhex/PKHeX

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/update-pkhex-submodule
          delete-branch: false
          commit-message: "chore(pkhex): bump submodule to ${{ steps.pkhex.outputs.latest_tag }}"
          title: "chore(pkhex): update PKHeX submodule to ${{ steps.pkhex.outputs.latest_tag }}"
          body: |
            This PR updates the `PKHeX` submodule to the latest upstream tag:

            - **Tag:** `${{ steps.pkhex.outputs.latest_tag }}`
          labels: |
            PKHeX
